# Hardware Task

Система управления роботом с 10 двигателями через SPI интерфейс для коммуникации с микроконтроллером STM32.

## Описание проекта

Hardware Task - это многопоточное C++ приложение для управления роботом, обеспечивающее:

- **SPI коммуникацию** с микроконтроллером STM32 (20 МГц)
- **Управление 10 двигателями** с PID контролем
- **Обработку данных IMU** (акселерометр, гироскоп, магнитометр)
- **Многопоточную архитектуру** с синхронизацией через мьютексы
- **Обмен данными** через разделяемую память (shared memory)
- **Конфигурацию** через константы в коде
- **Систему контроля соединения** с автоматическим восстановлением

## Зависимости

### Системные зависимости
- CMake (версия 3.10 или выше)
- GCC с поддержкой C++11
- pthread библиотека
- Linux SPI драйвер (spidev)

### Внешние библиотеки
- **serial** - для последовательной коммуникации

## Структура проекта

```
hardware_task/
├── src/           # Исходные файлы
│   ├── main.cpp   # Основной файл программы
│   ├── spi.cpp    # Реализация SPI интерфейса
│   ├── serial.cpp # Реализация последовательной коммуникации
│   ├── sys_timer.cpp # Системный таймер
│   └── comm.c    # Функции коммуникации
├── include/       # Заголовочные файлы
│   ├── spi_node.h # Определения SPI узлов
│   ├── spi.h      # SPI интерфейс
│   ├── serial.hpp # Последовательная коммуникация
│   ├── sys_time.h # Системное время
│   └── comm.h     # Заголовки коммуникации
├── library/       # Внешние библиотеки
│   └── serial/    # Библиотека serial
├── build/         # Сборка (игнорируется git)
└── CMakeLists.txt # Файл сборки CMake
```

## Протокол SPI коммуникации

### Общие параметры
- **Частота SPI:** 20 МГц (на Odroid)
- **Режим SPI:** Mode 0
- **Размер буфера:** 255 байт
- **Максимальная длина данных:** 160 байт
- **Задержка между передачами:** 250 мкс


### Данные, отправляемые НА STM32 (TX)

#### Структура пакета TX (108 байт)

**Примечание:** Размер TX пакета фиксированный и составляет 108 байт. Максимальный размер ограничен константой `SPI_SEND_MAX = 160` байт.

| Байт | Тип | Описание | Масштаб | Пример |
|------|-----|----------|---------|--------|
| 0 | uint8_t | Первый байт заголовка | - | `0xFE` |
| 1 | uint8_t | Второй байт заголовка | - | `0xFC` |
| 2 | uint8_t | ID команды | - | `0x2D` (45) |
| 3 | uint8_t | Количество байт данных | - | `0x68` (104) |
| 4 | uint8_t | `en_motor*100 + reset_q*10 + reset_err` | - | `100` (включить моторы) |
| 5 | uint8_t | `Acc_CALIBRATE*100 + Gyro_CALIBRATE*10 + Mag_CALIBRATE` | - | `0` (калибровка выключена) |
| 6 | uint8_t | Проигрываемый звуковой сигнал из заготовленных в STM32 | - | `0` (выключен) |
| 7-106 | {int16_t, int16_t, int16_t, int16_t, int16_t} × 10 | Данные всех двигателей 0-9:<br/>Для каждого: q_set[i], dq_set[i], tau_ff[i], kp, kd | q_set: ÷30.0<br/>dq_set: ÷20.0<br/>tau_ff: ÷500.0<br/>kp: ÷500.0<br/>kd: ÷1000.0 | `0` × 50 |
| 107 | uint8_t | Контрольная сумма | - | Вычисляется |

### Данные, получаемые ОТ STM32 (RX)

#### Структура пакета RX (121 байт)

**Примечание:** Фактический размер RX пакета может быть меньше 121 байта, так как размер данных указывается динамически в байте 3. Максимальный размер ограничен константой `SPI_SEND_MAX = 160` байт.

| Байт | Тип | Описание | Масштаб | Пример |
|------|-----|----------|---------|--------|
| 0 | uint8_t | Первый байт заголовка | - | `0xFF` |
| 1 | uint8_t | Второй байт заголовка | - | `0xFB` |
| 2 | uint8_t | Версия протокола | - | `0x1A` (26) |
| 3 | uint8_t | Количество байт данных | - | `0x75` (117) |
| 4-7 | float | Угол крена att[0] | - | `0.0f` (4 байта) |
| 8-11 | float | Угол тангажа att[1] | - | `0.0f` (4 байта) |
| 12-15 | float | Угол рысканья att[2] | - | `0.0f` (4 байта) |
| 16-19 | float | Угловая скорость крена att_rate[0] | - | `0.0f` (4 байта) |
| 20-23 | float | Угловая скорость тангажа att_rate[1] | - | `0.0f` (4 байта) |
| 24-27 | float | Угловая скорость рысканья att_rate[2] | - | `0.0f` (4 байта) |
| 28-31 | float | Ускорение по X acc_b[0] | - | `0.0f` (4 байта) |
| 32-35 | float | Ускорение по Y acc_b[1] | - | `0.0f` (4 байта) |
| 36-39 | float | Ускорение по Z acc_b[2] | - | `0.0f` (4 байта) |
| 40-109 | {int16_t, int16_t, int16_t, uint8_t} × 10 | Данные всех двигателей 0-9:<br/>Для каждого: q[i], dq[i], tau[i], connect_motor*10 + ready | q: ÷30.0<br/>dq: ÷30.0<br/>tau: ÷500.0<br/>статус: без масштаба | `0` × 40 |
| 110-120 | uint8_t[11] | Резерв (заполнено нулями) | - | `0` × 11 |
| 121 | uint8_t | Контрольная сумма | - | Вычисляется |

### Таблица масштабирования

| Тип данных | Поле | Формула | Диапазон int16_t | Диапазон реальных значений float |
|------------|------|---------|------------------|---------------------------|
| Позиции | q_set[i], q[i] | `значение / 30.0` | -32768 до 32767 | -1092.27 до 1092.23 рад |
| Скорости | dq_set[i] | `значение / 20.0` | -32768 до 32767 | -1638.4 до 1638.35 рад/с |
| Скорости | dq[i] | `значение / 30.0` | -32768 до 32767 | -1092.27 до 1092.23 рад/с |
| Моменты | tau_ff[i], tau[i] | `значение / 500.0` | -32768 до 32767 | -65.536 до 65.534 Н⋅м |
| Коэффициенты P | kp | `значение / 500.0` | -32768 до 32767 | -65.536 до 65.534 |
| Коэффициенты D | kd | `значение / 1000.0` | -32768 до 32767 | -32.768 до 32.767 |

**Практические примеры:**
- Чтобы передать позицию 1.5 рад: `1.5 × 30 = 45` → `0x2D 0x00`
- Чтобы передать скорость 2.0 рад/с: `2.0 × 20 = 40` → `0x28 0x00`  
- Чтобы передать момент 0.5 Н⋅м: `0.5 × 500 = 250` → `0xFA 0x00`

## Для сборки нужно:

### 1. Установить зависимости

```bash
# Обновить пакеты
sudo apt update

# Установить необходимые пакеты
sudo apt install build-essential cmake git
```

### 2. Клонировать и собрать проект

```bash
# Перейти в директорию проекта
cd hardware_task

# Создать директорию для сборки
mkdir -p build
cd build

# Сконфигурировать проект
cmake ..

# Собрать проект
make -j$(nproc)
```

### 3. Альтернативная сборка (из корневой директории)

```bash
# Создать директорию build в корне проекта
mkdir -p build
cd build

# Сконфигурировать и собрать
cmake ../hardware_task
make -j$(nproc)
```


## Использование

### Запуск программы

```bash
# Из директории build
./hardware_task_log

# Или с параметрами (если поддерживаются)
./hardware_task_log [опции]
```