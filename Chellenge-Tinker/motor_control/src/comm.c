/**
 * @file comm.c
 * @brief Функции для работы с разделяемой памятью (Shared Memory)
 *
 * @details
 * Реализует создание, получение и уничтожение сегментов разделяемой памяти
 * с использованием System V IPC. Использует ключ, сгенерированный через ftok()
 * на основе пути и идентификатора проекта.
 *
 */

#include "comm.h"

/**
 * @brief Внутренняя функция для работы с разделяемой памятью
 *
 * @param sz Размер сегмента разделяемой памяти в байтах
 * @param flag Флаги создания:
 *             - IPC_CREAT: создать если не существует
 *             - IPC_EXCL: завершиться ошибкой если существует
 *             - Права доступа (0666 и т.д.)
 * @return int Идентификатор разделяемой памяти или код ошибки:
 *             - >0: идентификатор shmid
 *             - -1: ошибка ftok()
 *             - -2: ошибка shmget()
 *
 * @details
 * Генерирует ключ с помощью ftok() используя PATHNAME и PROJ_ID из comm.h.
 * Создает или получает сегмент разделяемой памяти с указанными флагами.
 *
 * @note Внутренняя функция, используется createshm() и getshm()
 */
static int commshm(int sz, int flag)
{
    key_t key = ftok(PATHNAME, PROJ_ID);
    if (key < 0)
    {
        perror("ftok");
        return -1;
    }

    int shmid = 0;
    if ((shmid = shmget(key, sz, flag)) < 0)
    {
        perror("shmget");
        return -2;
    }

    return shmid;
}

/**
 * @brief Уничтожить сегмент разделяемой памяти
 *
 * @param shmid Идентификатор разделяемой памяти
 * @return int Результат операции:
 *             - 0: успех
 *             - -1: ошибка
 *
 * @details
 * Помечает сегмент разделяемой памяти для удаления с помощью IPC_RMID.
 * Фактическое удаление произойдет когда все процессы отсоединятся от сегмента.
 *
 * @warning После вызова этой функции сегмент будет удален системой
 *
 * @see shmctl()
 */
int destroyshm(int shmid)
{
    if (shmctl(shmid, IPC_RMID, NULL) < 0)
    {
        perror("shmctl");
        return -1;
    }
    return 0;
}

/**
 * @brief Создать новый сегмент разделяемой памяти
 *
 * @param sz Размер сегмента в байтах
 * @return int Идентификатор разделяемой памяти или код ошибки:
 *             - >0: идентификатор shmid
 *             - -1: ошибка ftok()
 *             - -2: ошибка shmget() (возможно сегмент уже существует)
 *
 * @details
 * Создает новый сегмент разделяемой памяти с флагами:
 * - IPC_CREAT: создать сегмент
 * - IPC_EXCL: гарантировать создание нового сегмента
 * - 0666: права доступа (чтение/запись для всех)
 *
 * @note Если сегмент уже существует, вернет ошибку
 *
 * @see getshm()
 */
int createshm(int sz)
{
    return commshm(sz, IPC_CREAT | IPC_EXCL | 0666);
}

/**
 * @brief Получить существующий сегмент разделяемой памяти
 *
 * @param sz Размер сегмента в байтах (должен соответствовать существующему)
 * @return int Идентификатор разделяемой памяти или код ошибки:
 *             - >0: идентификатор shmid
 *             - -1: ошибка ftok()
 *             - -2: ошибка shmget() (возможно сегмент не существует)
 *
 * @details
 * Получает существующий сегмент разделяемой памяти с флагом IPC_CREAT.
 * Если сегмент не существует, поведение зависит от системы.
 *
 * @note Размер должен соответствовать размеру существующего сегмента
 *
 * @see createshm()
 */
int getshm(int sz)
{
    return commshm(sz, IPC_CREAT);
}